--@include nabtech/lib/core/net.lua.txt

if not net.receive then
	require( "nabtech/lib/core/net.lua.txt" )
end

local included = {}

if CLIENT then
	function include ( fileName, callback )
        if not included[ fileName ] then
            if file.exists( fileName ) then
                included[ fileName ] = file.read( fileName )
            else
                error( "Unable to include \"" .. fileName .. "\"" )
            end
        end

        local ret
        if included[ fileName ] then
            try( function ()
                local ret = loadstring( included[ fileName ] )()
                if callback then
                    callback( fileName )
                end
            end, function ( err )
                throw( err, 3, true )
            end )
        end
        return ret
	end

	local function loadFileForNet ( name, data, ply )
		local fileName = data.file
        local code
		if fileName ~= "" and file.exists( fileName ) then
			 code = file.read( fileName )
		else
			code = "error( \"Unable to include \\\"" .. fileName .. "\\\"\" )"
        end

        net.send( "sv_include upload_file", { code = code } )
	end

	net.receive( "cl_include load_file", loadFileForNet )
else
	function include ( fileName, callback )
		if included[ fileName ] then
            included[ fileName ]()
            if callback then
                callback( fileName )
            end
            return
        end
        net.send( "cl_include load_file", { file = fileName }, owner() )

        local function includeNetData ( name, data, ply )
            net.remove( "sv_include upload_file" )
            included[ fileName ] = loadstring( data.code )
            included[ fileName ]()

            if callback then
                callback( fileName )
            end
        end

        net.receive( "sv_include upload_file", includeNetData )
    end
end
